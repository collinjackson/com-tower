rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Games: read-only for signed-in users.
    match /games/{gameId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Patches: only inviter can read; writes handled server-side.
    match /patches/{pid} {
      allow read: if request.auth != null && request.auth.uid == resource.data.inviterUid;
      allow write: if false;
    }

    // User profile: allow self read/write of phone only.
    match /users/{uid} {
      allow read, write: if request.auth != null
                         && request.auth.uid == uid
                         && request.resource.data.keys().hasOnly(['signalPhone', 'updatedAt'])
                         && request.resource.data.signalPhone is string
                         && request.resource.data.signalPhone.size() <= 20
                         && request.resource.data.signalPhone.matches('^\\+?[0-9]{7,15}$');
    }

    // Messages: read-only for everyone (activity feeds); writes via server.
    match /messages/{messageId} {
      allow read: if true;
      allow write: if false;
    }

    // Patch activity: audit log of subscriber changes; only patch owner can read.
    match /patchActivity/{activityId} {
      allow read: if request.auth != null && resource.data.inviterUid == request.auth.uid;
      allow write: if false;
    }

    // Deny everything else.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

